/*
 * Test TLS API System
 *
 * Copyright (C) 2020-2021, HENSOLDT Cyber GmbH
 *
 */

#include "config/SystemConfig.h"
import <std_connector.camkes>;

import <if_OS_Entropy.camkes>;
#include "EntropySource/camkes/EntropySource.camkes"
EntropySource_COMPONENT_DEFINE(EntropySource)

#include "TimeServer/camkes/TimeServer.camkes"
TimeServer_COMPONENT_DEFINE(TimeServer)

#include "os_network_stack/network_stack.camkes"
NwStack_COMPONENT_DEFINE(
    NwStack,
    NIC_DRIVER_RINGBUFFER_SIZE,
    1,
    NwStack_NO_ADDITIONAL_INTERFACES)

import "components/Ticker/Ticker.camkes";
import "components/Tests/test_OS_Tls.camkes";

#include "plat_nic.camkes"

assembly {
    composition {
        //----------------------------------------------------------------------
        // Ticker
        //----------------------------------------------------------------------
        component Ticker ticker;

        //----------------------------------------------------------------------
        // TimeServer
        //----------------------------------------------------------------------
        component TimeServer timeServer;

        TimeServer_INSTANCE_CONNECT_CLIENTS(
            timeServer,
            ticker.timeServer_rpc,  ticker.timeServer_notify,
            // platform specific components, macro will add a comma(s) if any
            TLS_API_TEST_NIC_CONNECTION_TIMESERVER(nwDriver)
            nwStack.timeServer_rpc, nwStack.timeServer_notify
        )

        //----------------------------------------------------------------------
        // Network Driver
        //----------------------------------------------------------------------
        TLS_API_TEST_NIC_INSTANCE(nwDriver)

        //----------------------------------------------------------------------
        // Network Stack
        //----------------------------------------------------------------------
        component NwStack nwStack;

        NwStack_INSTANCE_CONNECT(
            nwStack,
            ticker.e_timeout_nwstacktick,
            nwDriver
        )

        //----------------------------------------------------------------------
        // TLS UnitTest App
        //----------------------------------------------------------------------
        component test_OS_Tls unitTest;

        NwStack_INSTANCE_CONNECT_CLIENT(
            nwStack,
            unitTest,
            networkStack_rpc,
            networkStack_port)

        //----------------------------------------------------------------------
        // Entropy Source
        //----------------------------------------------------------------------
        component EntropySource entropySource;

        EntropySource_INSTANCE_CONNECT_CLIENT(
            entropySource,
            unitTest.entropy_rpc,
            unitTest.entropy_port
        )
    }

    configuration {
        TimeServer_CLIENT_ASSIGN_BADGES(
            ticker.timeServer_rpc,
            // platform specific components, macro will add a comma(s) if any
            TLS_API_TEST_NIC_TIMESERVER_CLIENTS(nwDriver)
            nwStack.timeServer_rpc
        )

        TLS_API_TEST_NIC_CONFIG(nwDriver)
    }
}
